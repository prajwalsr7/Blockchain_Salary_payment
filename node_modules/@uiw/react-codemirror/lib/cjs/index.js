"use strict";

var _interopRequireWildcard3 = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _interopRequireWildcard2 = _interopRequireDefault(require("@babel/runtime/helpers/interopRequireWildcard"));

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard3(require("react"));

var _codemirror = _interopRequireDefault(require("codemirror"));

require("codemirror/mode/meta");

var defaultOptions = {
  tabSize: 2,
  autoCloseBrackets: true,
  matchBrackets: true,
  showCursorWhenSelecting: true,
  // 显示行号
  lineNumbers: true,
  fullScreen: true
};

function ReactCodeMirror() {
  var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var ref = arguments.length > 1 ? arguments[1] : undefined;
  var _props$options = props.options,
      options = _props$options === void 0 ? {} : _props$options,
      _props$value = props.value,
      value = _props$value === void 0 ? '' : _props$value,
      _props$width = props.width,
      width = _props$width === void 0 ? '100%' : _props$width,
      _props$height = props.height,
      height = _props$height === void 0 ? '100%' : _props$height;

  var _useState = (0, _react.useState)(),
      _useState2 = (0, _slicedToArray2.default)(_useState, 2),
      editor = _useState2[0],
      setEditor = _useState2[1];

  var textareaRef = (0, _react.useRef)();
  var lastestProps = (0, _react.useRef)(props);
  (0, _react.useImperativeHandle)(ref, function () {
    return {
      editor: editor
    };
  }, [editor]);
  lastestProps.current = props; // 将props中所有的事件处理函数映射并保存

  function getEventHandleFromProps() {
    var propNames = Object.keys(props);
    var eventHandle = propNames.filter(function (keyName) {
      return /^on+/.test(keyName);
    });
    var eventDict = {};
    eventHandle.forEach(function (ele) {
      var name = ele.slice(2);

      if (name && name[0]) {
        eventDict[ele] = name.replace(name[0], name[0].toLowerCase());
      }
    });
    return eventDict;
  } // http://codemirror.net/doc/manual.html#config


  function setOptions(_x) {
    return _setOptions.apply(this, arguments);
  }

  function _setOptions() {
    _setOptions = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(instance) {
      var opt,
          mode,
          _args = arguments;
      return _regenerator.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              opt = _args.length > 1 && _args[1] !== undefined ? _args[1] : {};

              if (!((0, _typeof2.default)(opt) === 'object' && window)) {
                _context.next = 8;
                break;
              }

              mode = _codemirror.default.findModeByName(opt.mode || '');

              if (!(mode && mode.mode)) {
                _context.next = 6;
                break;
              }

              _context.next = 6;
              return Promise.resolve("codemirror/mode/".concat(mode.mode, "/").concat(mode.mode, ".js")).then(function (s) {
                return (0, _interopRequireWildcard2.default)(require(s));
              });

            case 6:
              if (mode) {
                opt.mode = mode.mime;
              }

              Object.keys(opt).forEach(function (name) {
                if ((opt[name] || opt[name] === false) && JSON.stringify(opt[name])) {
                  instance.setOption(name, opt[name]);
                }
              });

            case 8:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));
    return _setOptions.apply(this, arguments);
  }

  (0, _react.useEffect)(function () {
    if (!editor && window) {
      // 生成codemirror实例
      var instance = _codemirror.default.fromTextArea(textareaRef.current, (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultOptions), options));

      var eventDict = getEventHandleFromProps();
      Object.keys(eventDict).forEach(function (event) {
        instance.on(eventDict[event], function () {
          var _lastestProps$current;

          return (_lastestProps$current = lastestProps.current)[event].apply(_lastestProps$current, arguments);
        });
      });
      instance.setValue(value || '');

      if (width || height) {
        // 设置尺寸
        instance.setSize(width, height);
      }

      setEditor(instance);
      setOptions(instance, (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultOptions), options));
    }

    return function () {
      if (editor && window) {
        editor.toTextArea();
        setEditor(undefined);
      }
    };
  }, []);
  (0, _react.useMemo)(function () {
    if (!editor || !window) return;
    var val = editor.getValue();

    if (value !== undefined && value !== val) {
      editor.setValue(value);
    }
  }, [value]);
  (0, _react.useMemo)(function () {
    if (!editor || !window) return;
    editor.setSize(width, height);
  }, [width, height]);
  (0, _react.useMemo)(function () {
    if (!editor || !window) return;
    setOptions(editor, (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultOptions), options));
  }, [editor, options]);
  return /*#__PURE__*/_react.default.createElement("textarea", {
    ref: textareaRef
  });
}

var _default = /*#__PURE__*/_react.default.forwardRef(ReactCodeMirror);

exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0T3B0aW9ucyIsInRhYlNpemUiLCJhdXRvQ2xvc2VCcmFja2V0cyIsIm1hdGNoQnJhY2tldHMiLCJzaG93Q3Vyc29yV2hlblNlbGVjdGluZyIsImxpbmVOdW1iZXJzIiwiZnVsbFNjcmVlbiIsIlJlYWN0Q29kZU1pcnJvciIsInByb3BzIiwicmVmIiwib3B0aW9ucyIsInZhbHVlIiwid2lkdGgiLCJoZWlnaHQiLCJlZGl0b3IiLCJzZXRFZGl0b3IiLCJ0ZXh0YXJlYVJlZiIsImxhc3Rlc3RQcm9wcyIsImN1cnJlbnQiLCJnZXRFdmVudEhhbmRsZUZyb21Qcm9wcyIsInByb3BOYW1lcyIsIk9iamVjdCIsImtleXMiLCJldmVudEhhbmRsZSIsImZpbHRlciIsImtleU5hbWUiLCJ0ZXN0IiwiZXZlbnREaWN0IiwiZm9yRWFjaCIsImVsZSIsIm5hbWUiLCJzbGljZSIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsInNldE9wdGlvbnMiLCJpbnN0YW5jZSIsIm9wdCIsIndpbmRvdyIsIm1vZGUiLCJDb2RlTWlycm9yIiwiZmluZE1vZGVCeU5hbWUiLCJtaW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsInNldE9wdGlvbiIsImZyb21UZXh0QXJlYSIsImV2ZW50Iiwib24iLCJzZXRWYWx1ZSIsInNldFNpemUiLCJ0b1RleHRBcmVhIiwidW5kZWZpbmVkIiwidmFsIiwiZ2V0VmFsdWUiLCJSZWFjdCIsImZvcndhcmRSZWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR0EsSUFBTUEsY0FBYyxHQUFHO0FBQ3JCQyxFQUFBQSxPQUFPLEVBQUUsQ0FEWTtBQUVyQkMsRUFBQUEsaUJBQWlCLEVBQUUsSUFGRTtBQUdyQkMsRUFBQUEsYUFBYSxFQUFFLElBSE07QUFJckJDLEVBQUFBLHVCQUF1QixFQUFFLElBSko7QUFLckI7QUFDQUMsRUFBQUEsV0FBVyxF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QUFWO0FBQ0Q7O0FBQ0QsV0FBTyxZQUFNO0FBQ1gsVUFBSUksTUFBTSxJQUFJdUIsTUFBZCxFQUFzQjtBQUNwQnZCLFFBQUFBLE1BQU0sQ0FBQ29DLFVBQVA7QUFDQW5DLFFBQUFBLFNBQVMsQ0FBQ29DLFNBQUQsQ0FBVDtBQUNEO0FBQ0YsS0FMRDtBQU1ELEdBdkJELEVBdUJHLEVBdkJIO0FBeUJBLHNCQUFRLFlBQU07QUFDWixRQUFJLENBQUNyQyxNQUFELElBQVcsQ0FBQ3VCLE1BQWhCLEVBQXdCO0FBQ3hCLFFBQU1lLEdBQUcsR0FBR3RDLE1BQU0sQ0FBQ3VDLFFBQVAsRUFBWjs7QUFDQSxRQUFJMUMsS0FBSyxLQUFLd0MsU0FBVixJQUF1QnhDLEtBQUssS0FBS3lDLEdBQXJDLEVBQTBDO0FBQ3hDdEMsTUFBQUEsTUFBTSxDQUFDa0MsUUFBUCxDQUFnQnJDLEtBQWhCO0FBQ0Q7QUFDRixHQU5ELEVBTUcsQ0FBQ0EsS0FBRCxDQU5IO0FBUUEsc0JBQVEsWUFBTTtBQUNaLFFBQUksQ0FBQ0csTUFBRCxJQUFXLENBQUN1QixNQUFoQixFQUF3QjtBQUN4QnZCLElBQUFBLE1BQU0sQ0FBQ21DLE9BQVAsQ0FBZXJDLEtBQWYsRUFBc0JDLE1BQXRCO0FBQ0QsR0FIRCxFQUdHLENBQUNELEtBQUQsRUFBUUMsTUFBUixDQUhIO0FBTUEsc0JBQVEsWUFBTTtBQUNaLFFBQUksQ0FBQ0MsTUFBRCxJQUFXLENBQUN1QixNQUFoQixFQUF3QjtBQUN4QkgsSUFBQUEsVUFBVSxDQUFDcEIsTUFBRCw4REFBYWQsY0FBYixHQUFnQ1UsT0FBaEMsRUFBVjtBQUNELEdBSEQsRUFHRyxDQUFDSSxNQUFELEVBQVNKLE9BQVQsQ0FISDtBQUtBLHNCQUNFO0FBQVUsSUFBQSxHQUFHLEVBQUVNO0FBQWYsSUFERjtBQUdEOzs0QkFFY3NDLGVBQU1DLFVBQU4sQ0FBaUJoRCxlQUFqQixDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IHVzZVJlZiwgdXNlRWZmZWN0LCB1c2VJbXBlcmF0aXZlSGFuZGxlLCB1c2VTdGF0ZSwgdXNlTWVtbyB9IGZyb20gJ3JlYWN0JztcbmltcG9ydCBDb2RlTWlycm9yIGZyb20gJ2NvZGVtaXJyb3InO1xuaW1wb3J0ICdjb2RlbWlycm9yL21vZGUvbWV0YSc7XG5pbXBvcnQgJy4vY29kZW1pcnJvci5jc3MnO1xuXG5jb25zdCBkZWZhdWx0T3B0aW9ucyA9IHtcbiAgdGFiU2l6ZTogMixcbiAgYXV0b0Nsb3NlQnJhY2tldHM6IHRydWUsXG4gIG1hdGNoQnJhY2tldHM6IHRydWUsXG4gIHNob3dDdXJzb3JXaGVuU2VsZWN0aW5nOiB0cnVlLFxuICAvLyDmmL7npLrooYzlj7dcbiAgbGluZU51bWJlcnM6IHRydWUsXG4gIGZ1bGxTY3JlZW46IHRydWUsXG59XG5cbmZ1bmN0aW9uIFJlYWN0Q29kZU1pcnJvcihwcm9wcyA9IHt9LCByZWYpIHtcbiAgY29uc3QgeyBvcHRpb25zID0ge30sIHZhbHVlID0gJycsIHdpZHRoID0gJzEwMCUnLCBoZWlnaHQgPSAnMTAwJScgIH0gPSBwcm9wcztcbiAgY29uc3QgW2VkaXRvciwgc2V0RWRpdG9yXSA9IHVzZVN0YXRlKCk7XG4gIGNvbnN0IHRleHRhcmVhUmVmID0gdXNlUmVmKCk7XG4gIGNvbnN0IGxhc3Rlc3RQcm9wcyA9IHVzZVJlZihwcm9wcyk7XG5cbiAgdXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsICgpID0+ICh7IGVkaXRvciB9KSwgW2VkaXRvcl0pO1xuICBsYXN0ZXN0UHJvcHMuY3VycmVudCA9IHByb3BzO1xuICBcbiAgLy8g5bCGcHJvcHPkuK3miYDmnInnmoTkuovku7blpITnkIblh73mlbDmmKDlsITlubbkv53lrZhcbiAgZnVuY3Rpb24gZ2V0RXZlbnRIYW5kbGVGcm9tUHJvcHMoKSB7XG4gICAgY29uc3QgcHJvcE5hbWVzID0gT2JqZWN0LmtleXMocHJvcHMpO1xuICAgIGNvbnN0IGV2ZW50SGFuZGxlID0gcHJvcE5hbWVzLmZpbHRlcigoa2V5TmFtZSkgPT4ge1xuICAgICAgcmV0dXJuIC9eb24rLy50ZXN0KGtleU5hbWUpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZXZlbnREaWN0ID0ge307XG4gICAgZXZlbnRIYW5kbGUuZm9yRWFjaCgoZWxlKSA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gZWxlLnNsaWNlKDIpO1xuICAgICAgaWYgKG5hbWUgJiYgbmFtZVswXSkge1xuICAgICAgICBldmVudERpY3RbZWxlXSA9IG5hbWUucmVwbGFjZShuYW1lWzBdLCBuYW1lWzBdLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGV2ZW50RGljdDtcbiAgfVxuXG4gIC8vIGh0dHA6Ly9jb2RlbWlycm9yLm5ldC9kb2MvbWFudWFsLmh0bWwjY29uZmlnXG4gIGFzeW5jIGZ1bmN0aW9uIHNldE9wdGlvbnMoaW5zdGFuY2UsIG9wdCA9IHt9KSB7XG4gICAgaWYgKHR5cGVvZiBvcHQgPT09ICdvYmplY3QnICYmIHdpbmRvdykge1xuICAgICAgY29uc3QgbW9kZSA9IENvZGVNaXJyb3IuZmluZE1vZGVCeU5hbWUob3B0Lm1vZGUgfHwgJycpO1xuICAgICAgaWYgKG1vZGUgJiYgbW9kZS5tb2RlKSB7XG4gICAgICAgIGF3YWl0IGltcG9ydChgY29kZW1pcnJvci9tb2RlLyR7bW9kZS5tb2RlfS8ke21vZGUubW9kZX0uanNgKTtcbiAgICAgIH1cbiAgICAgIGlmIChtb2RlKSB7XG4gICAgICAgIG9wdC5tb2RlID0gbW9kZS5taW1lO1xuICAgICAgfVxuICAgICAgT2JqZWN0LmtleXMob3B0KS5mb3JFYWNoKChuYW1lKSA9PiB7XG4gICAgICAgIGlmICgob3B0W25hbWVdIHx8IG9wdFtuYW1lXSA9PT0gZmFsc2UpICYmIEpTT04uc3RyaW5naWZ5KG9wdFtuYW1lXSkpIHtcbiAgICAgICAgICBpbnN0YW5jZS5zZXRPcHRpb24obmFtZSwgb3B0W25hbWVdKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoIWVkaXRvciAmJiB3aW5kb3cpIHtcbiAgICAgIC8vIOeUn+aIkGNvZGVtaXJyb3Llrp7kvotcbiAgICAgIGNvbnN0IGluc3RhbmNlID0gQ29kZU1pcnJvci5mcm9tVGV4dEFyZWEodGV4dGFyZWFSZWYuY3VycmVudCwgey4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRpb25zfSk7XG4gICAgICBjb25zdCBldmVudERpY3QgPSBnZXRFdmVudEhhbmRsZUZyb21Qcm9wcygpO1xuICAgICAgT2JqZWN0LmtleXMoZXZlbnREaWN0KS5mb3JFYWNoKChldmVudCkgPT4ge1xuICAgICAgICBpbnN0YW5jZS5vbihldmVudERpY3RbZXZlbnRdLCAoLi4ucGFyYW1zKSA9PiBsYXN0ZXN0UHJvcHMuY3VycmVudFtldmVudF0oLi4ucGFyYW1zKSk7XG4gICAgICB9KTtcbiAgICAgIGluc3RhbmNlLnNldFZhbHVlKHZhbHVlIHx8ICcnKTtcblxuICAgICAgaWYgKHdpZHRoIHx8IGhlaWdodCkge1xuICAgICAgICAvLyDorr7nva7lsLrlr7hcbiAgICAgICAgaW5zdGFuY2Uuc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KTtcbiAgICAgIH1cbiAgICAgIHNldEVkaXRvcihpbnN0YW5jZSk7XG4gICAgICBzZXRPcHRpb25zKGluc3RhbmNlLCB7Li4uZGVmYXVsdE9wdGlvbnMsIC4uLm9wdGlvbnN9KTtcbiAgICB9XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGlmIChlZGl0b3IgJiYgd2luZG93KSB7XG4gICAgICAgIGVkaXRvci50b1RleHRBcmVhKCk7XG4gICAgICAgIHNldEVkaXRvcih1bmRlZmluZWQpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgW10pO1xuXG4gIHVzZU1lbW8oKCkgPT4ge1xuICAgIGlmICghZWRpdG9yIHx8ICF3aW5kb3cpIHJldHVybjtcbiAgICBjb25zdCB2YWwgPSBlZGl0b3IuZ2V0VmFsdWUoKTtcbiAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiB2YWx1ZSAhPT0gdmFsKSB7XG4gICAgICBlZGl0b3Iuc2V0VmFsdWUodmFsdWUpO1xuICAgIH1cbiAgfSwgW3ZhbHVlXSk7XG5cbiAgdXNlTWVtbygoKSA9PiB7XG4gICAgaWYgKCFlZGl0b3IgfHwgIXdpbmRvdykgcmV0dXJuO1xuICAgIGVkaXRvci5zZXRTaXplKHdpZHRoLCBoZWlnaHQpO1xuICB9LCBbd2lkdGgsIGhlaWdodF0pO1xuXG5cbiAgdXNlTWVtbygoKSA9PiB7XG4gICAgaWYgKCFlZGl0b3IgfHwgIXdpbmRvdykgcmV0dXJuO1xuICAgIHNldE9wdGlvbnMoZWRpdG9yLCB7Li4uZGVmYXVsdE9wdGlvbnMsIC4uLm9wdGlvbnN9KTtcbiAgfSwgW2VkaXRvciwgb3B0aW9uc10pO1xuICBcbiAgcmV0dXJuIChcbiAgICA8dGV4dGFyZWEgcmVmPXt0ZXh0YXJlYVJlZn0gLz5cbiAgKTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgUmVhY3QuZm9yd2FyZFJlZihSZWFjdENvZGVNaXJyb3IpO1xuIl19